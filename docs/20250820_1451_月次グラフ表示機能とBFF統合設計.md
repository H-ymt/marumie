# 月次グラフ表示機能とBFF統合設計

## 作業概要

### 目的
- `webapp/src/app/[slug]/transactions/page.tsx` に月次のグラフを表示する機能を実装
- 複数のserver actionsをBFF（Backend for Frontend）の観点から1つのアクションにまとめる

### 現状分析

#### 既存の構成
1. **ページ**: `webapp/src/app/[slug]/transactions/page.tsx`
   - `getTransactionsBySlugAction` を呼び出し、取引データを取得・表示
   - パラメータ: slug, page, perPage, transactionType, financialYear

2. **現在のAction**: `webapp/src/server/actions/get-transactions-by-slug.ts`
   - `GetTransactionsBySlugUsecase` を単独で呼び出し

3. **既存のUsecase**: `GetTransactionsBySlugUsecase`
   - 取引データの検索・ページネーション機能

4. **Repository**: `PrismaTransactionRepository`
   - 既に `getCategoryAggregationForSankey` メソッドが存在（Sankeyチャート用）

## 設計方針

### 1. 新しいUsecase作成

#### `GetMonthlyTransactionAggregationUsecase`
- **責務**: 指定されたslugとfinancialYearで月次の収入・支出合計を取得
- **入力パラメータ**:
  ```typescript
  interface GetMonthlyAggregationParams {
    slug: string;
    financialYear?: number;
  }
  ```
- **出力**:
  ```typescript
  interface MonthlyAggregationResult {
    month: number; // 1-12
    income: number;
    expense: number;
  }[]
  ```

### 2. Repository拡張

#### `ITransactionRepository`インターフェース拡張
新しいメソッドを追加:
```typescript
getMonthlyAggregation(
  politicalOrganizationId: string,
  financialYear?: number
): Promise<MonthlyAggregationResult[]>
```

#### `PrismaTransactionRepository`実装
- Prismaの`groupBy`を使用して月次集計を実行
- `transactionDate`から月を抽出してグルーピング
- `transactionType`で収入・支出を分離

### 3. BFF統合Action設計

#### 新しいAction: `getTransactionPageDataAction`
- **責務**: トランザクションページに必要なすべてのデータを一度に取得
- **呼び出すUsecase（並列実行）**:
  1. `GetTransactionsBySlugUsecase` - 取引一覧データ
  2. `GetMonthlyTransactionAggregationUsecase` - 月次グラフデータ
  3. `GetSankeyAggregationUsecase` - Sankeyチャートデータ

#### 統合Actionの実装方針
```typescript
export async function getTransactionPageDataAction(params: TransactionPageParams) {
  const [transactionData, monthlyData, sankeyData] = await Promise.all([
    transactionUsecase.execute(params),
    monthlyUsecase.execute({ slug: params.slug, financialYear: params.financialYear }),
    sankeyUsecase.execute({ slug: params.slug })
  ]);
  
  return {
    transactionData,
    monthlyData,
    sankeyData: sankeyData.sankeyData
  };
}
```

### 4. フロントエンド更新

#### ページコンポーネント更新
- 既存の`getTransactionsBySlugAction`呼び出しを`getTransactionPageDataAction`に変更
- 月次グラフコンポーネントを追加（Chart.js or Recharts使用想定）

## 実装手順

1. **Repository拡張**
   - `ITransactionRepository`に`getMonthlyAggregation`メソッド追加
   - `PrismaTransactionRepository`に実装

2. **Usecase作成**
   - `GetMonthlyTransactionAggregationUsecase`作成

3. **BFF Action作成**
   - `getTransactionPageDataAction`作成
   - 複数Usecaseの並列実行実装

4. **ページコンポーネント更新**
   - 新しいActionの呼び出しに変更
   - 月次グラフ表示機能追加

5. **テスト**
   - 各Usecaseの動作確認
   - 統合Actionのパフォーマンス確認

## 期待される効果

### パフォーマンス向上
- 複数のAPI呼び出しが1回に削減
- Promise.allによる並列処理でレスポンス時間短縮

### 保守性向上
- BFFパターンによりフロントエンド側のデータ取得ロジック簡素化
- 各Usecaseの責務が明確化

### 機能追加
- 月次グラフによる視覚的なデータ表示
- 政治資金の時系列トレンド把握が容易

## 注意点

- 既存の`getTransactionsBySlugAction`は段階的に非推奨化
- データベースクエリの最適化（インデックス確認）
- グラフ表示用ライブラリの選定と導入