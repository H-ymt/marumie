# 入れたいこと

- みらいまる見え政治資金の技術的バックグラウンドを公開
  - 実行環境の構成
    - vercel + Next.js + supabase
      - webapp / admin を別の vercel app として用意
      - 特定 BaaS に依存することには注意した。後述するように Interface を用いて適切な抽象化を挟むことで BaaS 依存はしないように実装した。
    - 高速化・最適化戦略
      - webapp にはページレイヤーと取得処理レイヤーで二重のキャッシュ戦略で高速化
      - データ取得は極力 RSC に寄せ、単一エンドポイントの ISR のみにする方針で、動的 fetch を排除し描画高速化, クローラーフレンドリーに
- コードの 95%を AI に書かせることができた工夫
  - 厳密に測ることはできないがコードベースの 95%以上は LLM が書いているはず
    - 自分と AI が交互に触ると AI が混乱するので、文字列修正など人がやったほうが早いことも指示を介してやってもらっている
    - コードベースは 17000 行。中規模アプリくらい。
    - ただし丸投げではなく設計とレビューはちゃんとやっている
    - またバグや悪い設計を産まないように仕組みの工夫を入れている
    - この記事ではその工夫を紹介したい
  - CLAUDE.md の設計
    - 以下に書くような重要な事項は CLAUDE.md に記載し常に意識させるようにしている
    - 実際の CLAUDE.md の内容の紹介
  - 設計手順
    - 複雑な機能（コンテキストを大量に使う機能）には、docs 以下にまずマークダウンで機能概要ドキュメントを作ってもらい、それを人がレビューしてから実装してもらっている
    - また定期的にリポジトリ構成を第三者的にレビューしてもらい、設計が崩れている部分がないか見てもらったりもしていた
  - クリーンアーキテクチャベースのファイル設計
    - 採用した構造
      - server 処理
        - エントリーポイント(loaders: 参照系, actions: 書き込み系)
        - 処理のまとまり(usecase)
        - ビジネスロジック(converter, validator など)
        - データアクセス層(repository)
    - 概要
      - 人間では省略したくなるレイヤー構造も、LLM であればきれいにやりきってくれる
      - 責務が分離されているので処理フローが混乱しにくい
      - BFF パターンを採用し、ページごとに一つのエンドポイントが複数の取得・変換処理を並列実行
        - load-top-page.ts 処理の具体例紹介
      - 依存注入を徹底したのでテストをしやすい構造に
      - ゆくゆく他の政党に使ってもらうことも踏まえ、Repo 層には interface を噛ませ依存性逆転もしている
        - supabase 以外の環境にも脱出しやすい
  - Next 設計として、client と server で分けて実行環境を明確化
    - LLM も混乱しないように、極力"import server-only"を行うことで実行環境を意識しやすく
    - admin と webapp で相似形の構造
  - pnpm によるモノレポ管理
    - LLM がまたいで参照できることで全体感をもった実装ができる。
    - ドメインオブジェクトは shared ディレクトリに配置し, webapp と admin から参照
  - figma mcp の活用
    - mcp(framelink) 経由でデザイン作業も claude code が実行可能
  - ガードレール
    - commit hook + biome で常時フォーマット
    - Github actions で lint, typecheck, test
    - 重要な変換・バリデーションには手厚くテスト
  - デバッグ環境
    - 文字列修正など簡単な変更は devin に投げて並列化
    - vercel の branch based preview 機能で、機能ごとに動作確認
- まとめ
  - 今回 95%以上を書かせることができたのは、スクラッチ・モダンな構成
