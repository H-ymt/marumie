# 月次収支グラフ実装設計

## 概要

Figmaデザインに基づいて、`webapp/src/client/components/organization-page/MonthlyTrendsSection.tsx` にバーグラフを追加する。

## Figmaデザイン分析

![Figmaデザイン](https://www.figma.com/design/c0SjX5g781flssTg68DxoZ/Mirai-Open-Data?node-id=9-5195)

### デザイン要素
- **グラフサイズ**: 926px × 462px
- **グラフタイプ**: バーグラフ（収入・支出の積み上げ）+ 収支線グラフ
- **カラー**: 
  - 収入: `#2AA693` (緑色)
  - 支出: `#DC2626` (赤色)
  - 収支線: `#4B5563` (濃いグレー、2px幅)
- **軸ラベル**:
  - X軸: 1月〜12月
  - Y軸: 0万円〜500万円
- **凡例**: 右下に「収入」「支出」「収支」
- **フォント**: Noto Sans JP (14px, font-weight: 500)
- **データラベル**: 各バーの上に数値表示（300万 など）

### 構造分析
- **ベースライン**: 中央の横線（`#4B5563`, 1px）で収入・支出を区分
- **収入バー**: ベースライン上に緑色で表示
- **支出バー**: ベースライン下に赤色で表示（負の値として描画）
- **収支線**: 線グラフ（`Vector 2`）で月次推移を表示
  - 線の色: `#4B5563` (濃いグレー)
  - 線の太さ: 2px
  - 収支 = 収入 - 支出 の計算値をプロット
  - 各月の収支差額をポイントで結んだ線グラフ

## 実装計画

### 1. ライブラリ選定
- **ApexCharts + react-apexcharts**: 混在グラフに最適化されたチャートライブラリ
- **理由**: 
  - Mixed Chart（バー+線）のビルトイン対応
  - SVGレンダリングによる高品質表示  
  - 既存コードベースでNivo（Sankeyチャート）、Recharts（線グラフ）を使用中
  - 設定なしでコンビネーションチャートが作成可能

### 2. 必要な依存関係
```json
{
  "apexcharts": "^3.45.0",
  "react-apexcharts": "^1.4.1"
}
```

### 3. データ構造の変更
現在の `MonthlyData` インターフェースは既に適切（収支は計算で導出）：
```typescript
interface MonthlyData {
  yearMonth: string; // "2025-01" 形式
  income: number;    // 収入（万円）
  expense: number;   // 支出（万円）
  // balance: income - expense として計算
}
```

### 4. コンポーネント設計

#### 4.1 メインコンポーネント構造
```typescript
MonthlyTrendsSection
├── CardHeader（既存）
└── MonthlyChart（新規作成）
    ├── Chart.js Bar Chart
    ├── カスタムプラグイン（データラベル）
    └── 凡例
```

#### 4.2 新規作成ファイル
- `webapp/src/client/components/organization-page/components/MonthlyChart.tsx` (既存パターンに合わせた配置)

### 5. 実装詳細

#### 5.1 ApexChartsの設定
- **チャートタイプ**: `mixed`（bar + line の組み合わせ）
- **series**:
  1. 収入バー（type: 'column', color: `#2AA693`）
  2. 支出バー（type: 'column', color: `#DC2626`, 負の値）
  3. 収支線（type: 'line', color: `#4B5563`, stroke: { width: 2 }）
- **yaxis**: 複数軸設定（バー用とライン用）
- **plotOptions**: { bar: { stacked: true } }

#### 5.2 スタイリング
- グラフ背景: 透明
- グリッドライン: `#E2E8F0` (1px)
- ベースライン: `#4B5563` (1px, 太め)
- データラベル: グラフ上部に表示

#### 5.3 レスポンシブ対応
- デスクトップ: 926px固定幅
- タブレット・モバイル: 幅100%で縦横比維持

### 6. 実装手順

1. **依存関係インストール**
   ```bash
   cd webapp && pnpm add apexcharts react-apexcharts
   ```

2. **MonthlyChartコンポーネント作成**
   - Mixed Chart（バー + 線グラフ）の実装
   - データ変換ロジック（収支計算含む）
   - ApexChartsオプション設定

3. **MonthlyTrendsSectionの更新**
   - JSONデータ表示を削除
   - MonthlyChartコンポーネントを統合

4. **テスト・調整**
   - デザインとの比較
   - レスポンシブ確認
   - データなし状態の処理

### 7. 技術的考慮事項

#### 7.1 パフォーマンス
- ApexChartsの動的インポート
- SVGレンダリングの最適化

#### 7.2 アクセシビリティ
- ARIA ラベルの設定
- キーボードナビゲーション対応
- 色以外での区別方法

#### 7.3 エラーハンドリング
- データ不正時の対応
- チャートレンダリング失敗時のフォールバック

## まとめ

ApexChartsのMixed Chartを使用して、Figmaデザインに忠実な月次収支グラフを実装する。バーグラフ（収入・支出）と線グラフ（収支推移）を組み合わせることで、データの視覚化を効果的に行う。既存のコンポーネント構造と配置パターンを活かしつつ、新しいチャートコンポーネントを追加する。

### 重要な実装ポイント
- **収支線の計算**: `income - expense` で各月の収支を算出
- **Mixed Chart**: ApexChartsのビルトイン機能でバー+線グラフを表示
- **コンポーネント配置**: `organization-page/components/` 以下に配置（既存パターンに合わせる）
- **色彩の統一**: Figmaデザインの色指定に忠実に再現