# 寄付金額推移グラフ実装設計

## 概要
DonationSummarySectionの「直近1ヶ月の寄付金額推移」グラフを実装するための設計書。

## 現状分析

### 既存実装の確認
- **ファイル**: `webapp/src/client/components/organization-page/DonationSummarySection.tsx`
- **現在の状態**: JSONデータ表示（70-72行目）またはプレースホルダー（75-81行目）
- **データソース**: `dailyDonationData` (DailyDonationData[])

### データ構造
```typescript
interface DailyDonationData {
  date: string; // "YYYY-MM-DD" 形式
  dailyAmount: number; // その日の寄付額
  cumulativeAmount: number; // 累積寄付額
}
```

## UI要件（画像分析結果）

### グラフの特徴
1. **グラフタイプ**: 滑らかなラインチャート（spline/curve）
2. **データ**: 累積寄付金額（cumulativeAmount）を表示
3. **期間**: 直近1ヶ月（約1ヶ月分のデータポイント）
4. **Y軸**: 
   - 範囲: 0円 〜 2億円
   - 表記: "0.5億", "1億", "1.5億", "2億"
5. **X軸**: 
   - 日付表示: "7/18", "7/25", "8/5", "8/12", "8/19"
   - 約1週間間隔でラベル表示
6. **色**: 緑系（#10B981 または類似色）
7. **背景**: 白背景
8. **サイズ**: 高さ約287px（既存プレースホルダーと同じ）

## 技術選定

### グラフライブラリ
**推奨**: Recharts
- 理由: React製、軽量、カスタマイズ性が高い
- Next.js との親和性が良い
- TypeScript対応

### 代替案
1. Chart.js + react-chartjs-2
2. D3.js（カスタマイズ重視の場合）
3. Victory（Formidableメンテナンス）

## 実装設計

### コンポーネント構成
```
DonationSummarySection.tsx
├── DonationSummaryCards.tsx (既存)
└── DonationChart.tsx (新規作成)
    ├── ChartContainer (ラッパー)
    ├── ResponsiveContainer (Recharts)
    ├── LineChart (Recharts)
    ├── Line (Recharts)
    ├── XAxis (Recharts)
    ├── YAxis (Recharts)
    └── Tooltip (Recharts)
```

### 新規ファイル
1. **DonationChart.tsx**
   - パス: `webapp/src/client/components/organization-page/DonationChart.tsx`
   - 役割: 寄付推移ラインチャートの描画

### DonationChart.tsx の設計

#### Props インターフェース
```typescript
interface DonationChartProps {
  data: DailyDonationData[];
  height?: number;
}
```

#### 主要機能
1. **データ前処理**
   - 直近1ヶ月のデータフィルタリング
   - X軸ラベル用の日付フォーマット（M/d形式）
   - Y軸用の金額正規化（億単位変換）

2. **チャート設定**
   - Line: smooth curve, stroke color #10B981
   - XAxis: 週間隔のティック、日付フォーマット
   - YAxis: 億単位表示、カスタムフォーマッター
   - Tooltip: 金額と日付の詳細表示
   - ResponsiveContainer: 親要素に応じたリサイズ

3. **スタイリング**
   - 高さ: 287px（デフォルト）
   - 背景色: 白
   - パディング・マージンの調整

#### データ処理ロジック
```typescript
// 1. 直近30日のデータ抽出
const last30Days = data.slice(-30);

// 2. Y軸ラベル用億単位変換
const formatYAxisLabel = (value: number) => {
  if (value === 0) return '0円';
  return `${(value / 100000000).toFixed(1)}億`;
};

// 3. X軸ラベル用日付フォーマット
const formatXAxisLabel = (dateStr: string) => {
  const date = new Date(dateStr);
  return `${date.getMonth() + 1}/${date.getDate()}`;
};

// 4. Tooltip用詳細フォーマット
const formatTooltip = (value: number, dateStr: string) => {
  // 金額: "1億7462万4000円"
  // 日付: "2025年8月19日"
};
```

## DonationSummarySection.tsx の修正

### 変更箇所
**70-81行目** の既存プレースホルダー部分を以下に置換:

```tsx
{/* 寄付推移グラフ */}
{dailyDonationData.length > 0 ? (
  <DonationChart data={dailyDonationData} />
) : (
  <div className="h-[287px] bg-gray-50 rounded-lg flex items-center justify-center">
    <div className="text-center text-gray-500">
      <div className="text-lg font-medium mb-2">直近1ヶ月の寄付金額の推移</div>
      <div className="text-sm">データがありません</div>
    </div>
  </div>
)}
```

### import追加
```tsx
import DonationChart from './DonationChart';
```

## パッケージ依存関係

### 追加するパッケージ
```json
{
  "dependencies": {
    "recharts": "^2.8.0"
  },
  "devDependencies": {
    "@types/recharts": "^1.8.29"
  }
}
```

## 実装順序

1. **パッケージインストール**
   ```bash
   pnpm add recharts
   pnpm add -D @types/recharts
   ```

2. **DonationChart.tsx作成**
   - 基本的なLineChart実装
   - データ前処理ロジック
   - スタイリング

3. **DonationSummarySection.tsx修正**
   - DonationChart import
   - プレースホルダー置換

4. **テスト・調整**
   - 実データでの表示確認
   - レスポンシブ対応チェック
   - アクセシビリティ確認

## 注意事項

1. **import文**: DonationChart.tsxには`import "client-only";`を追加（インタラクティブなグラフのため）
2. **エラーハンドリング**: データが空/不正な場合の fallback UI
3. **パフォーマンス**: 大量データ時の最適化（必要に応じて）
4. **アクセシビリティ**: ARIA属性、キーボードナビゲーション対応

## 将来の拡張予定

1. **インタラクション**: データポイントクリック時の詳細表示
2. **期間選択**: 1ヶ月/3ヶ月/1年の切り替え機能
3. **アニメーション**: チャート描画時のスムーズなアニメーション
4. **Export機能**: PNG/SVGでのグラフ出力機能