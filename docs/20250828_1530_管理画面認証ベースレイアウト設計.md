# 管理画面認証ベースレイアウト設計

## 概要

現在の管理画面では全てのページでサイドバーが表示されているが、ログイン後のページのみにサイドバーを表示するよう変更する。

## 現状の問題

- ログインページでもサイドバーが表示される
- 認証状態に関係なく同一のレイアウトが適用される
- 認証チェックとレイアウト制御が分離されている

## 設計方針

Next.js App RouterのRoute Groupsを活用し、認証状態に基づいてレイアウトを切り替える。

## 新しいディレクトリ構造

```
admin/src/app/
├── (public)/              # 認証不要なページ群
│   ├── login/
│   │   └── page.tsx
│   └── layout.tsx         # サイドバーなしレイアウト
├── (auth)/                # 認証必要なページ群
│   ├── dashboard/
│   │   └── page.tsx
│   ├── users/
│   │   └── page.tsx
│   ├── [他の既存ページ]/
│   └── layout.tsx         # サイドバーありレイアウト + 認証チェック
├── layout.tsx             # ルートレイアウト（全体共通）
└── globals.css
```

## レイアウト責任分離

### `layout.tsx` (ルートレイアウト)
- HTML基本構造
- グローバルスタイル
- プロバイダー設定

### `(public)/layout.tsx`
- 認証不要ページ用レイアウト
- サイドバーなし
- シンプルな構造

### `(auth)/layout.tsx`
- 認証必要ページ用レイアウト
- サーバーサイド認証チェック
- サイドバー付きレイアウト
- 未認証時のリダイレクト処理

## 認証フロー

1. `(auth)/layout.tsx`でサーバーサイド認証チェック
2. 未認証の場合は`/login`にリダイレクト
3. 認証済みの場合はサイドバー付きレイアウトを表示

## 実装詳細

### 認証チェック
```typescript
// (auth)/layout.tsx (サーバーコンポーネント)
import "server-only";
import { redirect } from 'next/navigation';
import { getServerSession } from 'next-auth';

export default async function AuthLayout({ children }) {
  const session = await getServerSession();
  
  if (!session) {
    redirect('/login');
  }
  
  return (
    <div className="flex">
      <Sidebar />
      <main>{children}</main>
    </div>
  );
}
```

### 既存middleware.tsとの連携
- 現在のmiddleware.tsの認証ロジックと整合性を保つ
- 二重チェックにならないよう調整

## マイグレーション手順

1. `(public)`ディレクトリ作成とログインページ移動
2. `(auth)`ディレクトリ作成と既存ページ移動
3. 各レイアウトファイル作成
4. 認証ロジック実装
5. テスト・動作確認

## メリット

- **明確な責任分離**: 認証の有無でレイアウトが自動切り替え
- **サーバーサイド認証**: クライアントに到達前のブロック
- **保守性向上**: 認証ロジックの一元化
- **Next.js標準**: Route Groupsの適切な活用

## 注意点

- 既存のルーティングが変更されないよう注意
- middleware.tsとの重複処理を避ける
- SEO・アクセシビリティの考慮