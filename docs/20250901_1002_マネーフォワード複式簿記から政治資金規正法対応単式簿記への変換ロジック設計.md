# マネーフォワード複式簿記から政治資金規正法対応単式簿記への変換ロジック設計

## 概要

本ドキュメントは、マネーフォワード（MoneyForward）の会計システムから出力された複式簿記形式のデータを、政治資金規正法に準拠した単式簿記形式に変換するロジックについて説明する。

## 背景・目的

政治資金規正法では、政治団体の収支報告書は単式簿記方式での記載が求められる。一方、マネーフォワードなどの一般的な会計ソフトは複式簿記方式でデータを管理している。このギャップを埋めるため、複式簿記の仕訳データから政治資金規正法に準拠した単式簿記データへの変換処理が必要となる。

## 変換ロジックの基本原理

### 複式簿記 vs 単式簿記の違い

- **複式簿記**: 一つの取引について借方（Debit）・貸方（Credit）の 2 つの側面で記録
- **単式簿記（政治資金規正法）**: 収入・支出のいずれか一方のみを記録

### 変換の基本ルール

マネーフォワードの仕訳データでは「普通預金」勘定を基軸として取引を判定し、以下のルールで変換する：

1. **収入取引**: `借方 = 普通預金` の場合

   - 貸方の勘定科目から政治資金規正法上の収入区分を決定

2. **支出取引**: `貸方 = 普通預金` の場合

   - 借方の勘定科目から政治資金規正法上の支出区分を決定

3. **相殺取引**: 支出・収入に相当しない資金移動を扱うための特殊な科目
   - `借方 = 相殺項目（費用）` → 支出の相殺
   - `貸方 = 相殺項目（収入）` → 収入の相殺

## 具体的な勘定科目マッピング

### 収入項目のマッピング

| マネーフォワード勘定科目                   | 政治資金規正法上の区分               |
| ------------------------------------------ | ------------------------------------ |
| 個人の負担する党費又は会費                 | 機関紙誌+その他事業収入 > 党費・会費 |
| 個人からの寄附                             | 寄附 > 個人からの寄附                |
| 個人からの寄附（特定寄附）                 | 寄附 > 個人からの寄附                |
| 法人その他の団体からの寄附                 | 寄附 > 法人その他の団体からの寄附    |
| 政治団体からの寄附                         | 寄附 > 政治団体からの寄附            |
| 政党匿名寄附                               | 寄附 > 政党匿名寄附                  |
| 機関紙誌の発行その他の事業による収入       | 機関紙誌+その他事業収入              |
| 借入金                                     | 借入金                               |
| 本部又は支部から供与された交付金に係る収入 | 交付金                               |
| その他の収入                               | その他                               |

### 支出項目のマッピング

| マネーフォワード勘定科目     | 政治資金規正法上の区分                |
| ---------------------------- | ------------------------------------- |
| 人件費                       | 経常経費 > 人件費                     |
| 光熱水費                     | 経常経費 > 光熱水費                   |
| 備品・消耗品費               | 経常経費 > 備品・消耗品費             |
| 事務所費                     | 経常経費 > 事務所費                   |
| 組織活動費                   | 政治活動費 > 組織活動費               |
| 選挙関係費                   | 政治活動費 > 選挙関係費               |
| 機関紙誌の発行事業費         | 政治活動費 > 機関紙誌の発行事業費     |
| 宣伝事業費                   | 政治活動費 > 宣伝費                   |
| 政治資金パーティー開催事業費 | 政治活動費 > 政治資金パーティー開催費 |
| その他の事業費               | 政治活動費 > その他の事業費           |
| 調査研究費                   | 政治活動費 > 調査研究費               |
| 寄附・交付金                 | 政治活動費 > 寄附・交付金             |
| その他の経費                 | 政治活動費 > その他の経費             |
| 貸付金                       | 貸付金                                |

## 変換処理の実装詳細

### 1. 取引タイプの判定ロジック（`determineTransactionType`）

```typescript
private determineTransactionType(debitAccount: string, creditAccount: string): TransactionType | null {
  if (debitAccount === "相殺項目（費用）") return "offset_expense";
  if (creditAccount === "相殺項目（収入）") return "offset_income";
  if (debitAccount === "普通預金") return "income";      // 普通預金増加 = 収入
  if (creditAccount === "普通預金") return "expense";     // 普通預金減少 = 支出
  return null;                                           // 判定不能
}
```

### 2. カテゴリーキー決定ロジック（`determineCategoryKey`）

```typescript
private determineCategoryKey(debitAccount: string, creditAccount: string): string {
  if (debitAccount === "普通預金") {
    // 収入の場合：貸方の勘定科目から判定
    const mapping = ACCOUNT_CATEGORY_MAPPING[creditAccount];
    return mapping ? mapping.key : "undefined";
  } else if (creditAccount === "普通預金") {
    // 支出の場合：借方の勘定科目から判定
    const mapping = ACCOUNT_CATEGORY_MAPPING[debitAccount];
    return mapping ? mapping.key : "undefined";
  } else {
    // 普通預金が関与しない場合は未定義
    return "undefined";
  }
}
```

### 3. 金額処理

- 複式簿記では借方・貸方両方に金額が記録されるが、単式簿記では取引タイプに応じて適切な金額を選択
- カンマや空白文字を除去して数値として解析
- 解析エラーの場合は 0 として処理

## エラー処理

### 無効な取引パターン

以下の場合、取引は `invalid` として扱われる：

1. 借方・貸方ともに「普通預金」以外で、かつ相殺項目でもない場合
2. 勘定科目がマッピングテーブルに存在しない場合

### データ検証

- 金額フィールドの妥当性チェック
- 日付フォーマットの検証
- 必須フィールドの存在確認

## 年度処理

拡張性のため financialYear の概念が存在しているが、実際には 1 月から 12 月の期間で素直に取り込まれる仕様になっている

## 制限事項・注意点

1. **取引の複雑性**: 普通預金を経由しない複雑な取引（資産間の振替等）は適切に処理されない可能性がある

## データ処理パイプライン全体の流れ

### 1. プレビュー段階（`PreviewMfCsvUsecase`）

CSV 取り込み後、以下のステップで処理される：

1. **CSV 解析**: `MfCsvLoader`でマネーフォワードの CSV データを解析
2. **複式 → 単式変換**: `MfRecordConverter`で政治資金規正法形式に変換
3. **バリデーション**: `TransactionValidator`で以下をチェック
   - 勘定科目の妥当性（`ACCOUNT_CATEGORY_MAPPING` への登録確認）
   - `friendly_category`の設定確認（相殺取引以外）
   - 既存取引との重複チェック（`transaction_no`とhashによる比較）
4. **ステータス決定**: 各取引に `insert`/`update`/`invalid`/`skip` のステータスを付与

### 2. 保存段階（`SavePreviewTransactionsUsecase`）

プレビューで確認されたデータのうち、以下の条件を満たすもののみ DB に保存される：
- `status = "insert"` または `status = "update"`
- `transaction_type !== null`

保存処理では insert と update を分けて bulk 処理を行い、効率的にデータベースに反映する。

## データステータスとスキップ条件

### ステータス種類

| ステータス | 説明                                                         | 次工程での扱い  |
| ---------- | ------------------------------------------------------------ | --------------- |
| `insert`   | 新規取引（`transaction_no`が既存DBに存在しない）            | DB 保存対象     |
| `update`   | 更新取引（`transaction_no`は存在するがhashが異なる）         | DB 保存対象     |
| `invalid`  | バリデーションエラー、`transaction_type`が`null`             | DB 保存されない |
| `skip`     | 重複取引（同一`transaction_no`かつ同一hash）                 | DB 保存されない |

### スキップされる条件

1. **勘定科目の妥当性エラー（`invalid`）**:
   - 借方・貸方の勘定科目が `ACCOUNT_CATEGORY_MAPPING`、「普通預金」、「相殺項目（費用）」、「相殺項目（収入）」のいずれにも該当しない
   - エラーメッセージ例: `"無効な借方科目: \"○○\""`

2. **friendly_category未設定エラー（`invalid`）**:
   - 相殺取引以外で `friendly_category` が空文字またはnull
   - エラーメッセージ: `"独自のカテゴリが設定されていません"`

3. **取引タイプ判定エラー（`invalid`）**:
   - 借方・貸方どちらも「普通預金」でなく、相殺項目でもない場合
   - 政治資金規正法上の収入・支出・相殺に分類できない取引パターン
   - この場合 `transaction_type` は `null` として処理される

4. **完全重複データ（`skip`）**:
   - 同一の `transaction_no` が既に DB に存在し、かつ既存データとhashが同一
   - エラーメッセージ: `"重複のためスキップされます"`
