# CSVプレビューとUsecase統一設計

## 概要

現在のCSVアップロード機能において、プレビュー表示と実際の保存処理でバリデーション・変換ロジックが異なるため、これを統一する設計を行う。

## 現在の問題

### 現在の実装構造

1. **プレビュー**: `CsvPreview.tsx`
   - 独自のCSV解析ロジック
   - 簡易的なバリデーション（ヘッダーチェックのみ）
   - 表示用の独自データ構造

2. **保存処理**: `UploadMfCsvUsecase`
   - `MfCsvLoader` → `TransactionValidator` → `MfRecordConverter` の流れ
   - 厳密なバリデーション（勘定科目の妥当性チェック等）
   - Transactionモデルへの変換

### 問題点

- バリデーションロジックの重複・不一致
- プレビューで通ったデータが実際の保存で失敗する可能性
- メンテナンス性の低下

## 新設計

### アーキテクチャ

```
CSV File → PreviewMfCsvUsecase → PreviewTransaction[]
                                        ↓
                                  JSON POST
                                        ↓
                          UploadMfCsvUsecase → Transaction保存
```

**フロー詳細:**
1. **プレビュー段階**: CSV → PreviewMfCsvUsecase → PreviewTransaction[]
2. **ユーザー確認**: フロントエンドでPreviewTransaction[]を表示
3. **保存段階**: PreviewTransaction[] → JSON POST → UploadMfCsvUsecase

### 新規作成クラス: `PreviewMfCsvUsecase`

```typescript
interface PreviewMfCsvInput {
  csvContent: string;
  politicalOrganizationId: string;
}

interface PreviewTransaction {
  // 基本的なTransactionデータ
  transaction_no: string;
  transaction_date: Date;
  debit_account: string;
  debit_amount: number;
  credit_account: string;
  credit_amount: number;
  description: string;
  
  // プレビュー専用フィールド
  status: 'valid' | 'invalid' | 'skip';
  errors: string[];
  skipReason?: string; // 重複スキップ等の理由
}

interface PreviewMfCsvResult {
  transactions: PreviewTransaction[];
  summary: {
    totalCount: number;
    validCount: number;
    invalidCount: number;
    skipCount: number;
  };
}
```

### 設計原則

1. **共通モジュールの活用**
   - `MfCsvLoader`、`TransactionValidator`、`MfRecordConverter`を再利用
   - バリデーションロジックの統一

2. **プレビュー専用情報の追加**
   - `status`: 各レコードの状態（valid/invalid/skip）
   - `errors`: バリデーションエラー詳細
   - `skipReason`: スキップ理由（重複等）

3. **重複チェック機能**
   - 既存データとの重複チェック（transaction_noベース）
   - スキップ予定レコードの明示

## 実装計画

### Phase 1: PreviewMfCsvUsecaseの作成 ✅
- 基本的なプレビュー機能の実装
- 既存モジュール（Loader, Validator, Converter）の統合
- TransactionRepositoryにfindByTransactionNos機能追加

### Phase 2: UploadMfCsvUsecaseの変更
- 入力を`PreviewTransaction[]`に変更
- PreviewTransactionからCreateTransactionInputへの変換ロジック追加

### Phase 3: APIエンドポイントの作成/更新
- `/api/preview-csv`エンドポイント（新規）
- `/api/upload-csv`エンドポイント（JSON対応に変更）

### Phase 4: CsvPreviewコンポーネントの更新
- PreviewMfCsvUsecaseを使用するよう変更
- ステータス表示機能の追加（valid/invalid/skip）
- エラー・スキップ理由の表示
- JSON POST対応

## 期待効果

1. **一貫性の確保**
   - プレビューと実際の処理で同じバリデーション
   - データ変換ロジックの統一

2. **ユーザビリティ向上**
   - スキップ予定レコードの事前表示
   - 詳細なエラー情報の提供

3. **保守性向上**
   - ロジックの一元化
   - テストしやすい構造

## 技術的考慮事項

### パフォーマンス
- 重複チェックはINクエリで効率化
- JSON形式で効率的なデータ転送（1000行で500-800KB程度）
- CSVパース・バリデーション処理の重複実行を回避

### エラーハンドリング
- CSVパース、バリデーション、DB接続の各段階でのエラー対応
- 部分的成功の場合の適切な情報表示

### セキュリティ
- CSVファイルサイズの制限
- SQLインジェクション対策（Prisma使用により基本対応済み）